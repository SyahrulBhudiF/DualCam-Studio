import{k as I,b as M,r as d,m as P,j as e,n as z}from"./main-DZWvjlLQ.js";import{u as _,L as A}from"./label-B01KzJ1v.js";import{u as B}from"./useMutation-D6MBcEm7.js";import{u as T,C as F,R as G,a as U}from"./use-camera-setup-b0r95oto.js";import{B as V}from"./button-DhTWMI0i.js";import{C as $,a as q,b as O,d as Q}from"./card-CksVaWOc.js";import{u as H}from"./UserStore-CFJDJ2oP.js";import"./utils-CwvXAYlB.js";import"./index-BIv2WHLP.js";import"./index-COLG3_It.js";import"./index-tXSsdQnT.js";import"./index-xaBr0Lpv.js";const E=m=>new Promise((l,a)=>{const i=new FileReader;i.onloadend=()=>l(i.result),i.onerror=a,i.readAsDataURL(m)});function J(){const{questionnaire:m,questions:l}=I({from:"/questionnaire/"}),a=H().user,i=M(),[n,D]=d.useState(""),{videoDevices:h,deviceIdMain:j,setDeviceIdMain:g,deviceIdSec:c,setDeviceIdSec:S,videoRefMain:v,videoRefSec:w,realSenseRef:N,isRecording:u,allReady:x,setSecReady:R,startRecording:C,stopRecording:L}=T(),f=B({mutationFn:P,onSuccess:()=>i({to:"/success"}),onError:s=>{console.error(s),alert("Failed to submit.")}}),p=_({defaultValues:{answers:{}},onSubmit:async({value:s})=>{if(!a?.name||!a?.class){alert("User profile missing");return}const{blobMain:r,blobSec:o}=await L();await new Promise(k=>setTimeout(k,1500));let t="";r.size>0&&(t=await E(r));let b="";c!=="ws-realsense"&&o&&o.size>0?b=await E(o):c==="ws-realsense"&&(b="SAVED_ON_SERVER"),await f.mutateAsync({data:{userEmail:a.email||"",userName:a.name,userClass:a.class,userSemester:a.semester||"",userGender:a.gender||"",userAge:a.age||0,userNim:a.nim||"",questionnaireId:m.id,videoBase64Main:t,videoBase64Secondary:b||" ",folderName:n,answers:s.answers}})}});d.useEffect(()=>{if(a?.name&&!n){const s=Date.now(),r=a.name.replace(/[^a-z0-9]/gi,"_").toLowerCase();D(`full/${r}_${s}`)}},[a?.name,n]);const y=d.useRef(!1);return d.useEffect(()=>{if(x&&!u&&n&&!y.current){const s=setTimeout(()=>{C({folderName:n,mode:"FULL"}),y.current=!0},1e3);return()=>clearTimeout(s)}},[x,u,C,n]),x?e.jsxs("div",{className:"min-h-screen bg-primary p-4 pb-48",children:[e.jsxs("div",{className:"max-w-3xl mx-auto mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold dark:text-slate-50",children:m.title}),e.jsxs("p",{className:"text-slate-600 dark:text-slate-400",children:["Student:"," ",e.jsx("span",{className:"font-semibold dark:text-slate-200",children:a?.name||"Guest"})," ","| Class:"," ",e.jsx("span",{className:"font-semibold dark:text-slate-200",children:a?.class||"-"})]})]}),e.jsx("div",{className:"max-w-3xl mx-auto space-y-6",children:e.jsxs("form",{onSubmit:s=>{s.preventDefault(),s.stopPropagation(),p.handleSubmit()},children:[l?.map((s,r)=>e.jsxs($,{className:"mb-6",children:[e.jsx(q,{children:e.jsxs(O,{className:"text-lg",children:[r+1,". ",s.question_text]})}),e.jsx(Q,{children:e.jsx(p.Field,{name:`answers.${s.id}`,children:o=>e.jsx(G,{onValueChange:t=>o.handleChange(t),value:o.state.value,children:s.answers.map(t=>e.jsxs("div",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx(U,{value:t.id,id:t.id}),e.jsx(A,{htmlFor:t.id,children:t.answer_text})]},t.id))})})})]},s.id)),e.jsx(p.Subscribe,{selector:s=>({answers:s.values.answers,isSubmitting:s.isSubmitting}),children:({answers:s,isSubmitting:r})=>e.jsx(V,{className:"w-full mt-8 dark:bg-blend-saturation cursor-pointer",size:"lg",type:"submit",disabled:!l||Object.keys(s).length!==l.length||r||f.isPending,children:r||f.isPending?"Finalizing...":"Submit Answers"})})]})}),e.jsx(F,{videoDevices:h,deviceIdMain:j,setDeviceIdMain:g,deviceIdSec:c,setDeviceIdSec:S,videoRefMain:v,videoRefSec:w,realSenseRef:N,isRecording:u,onSecReady:()=>R(!0)})]}):e.jsxs("div",{className:"min-h-screen flex flex-col items-center justify-center bg-slate-50 gap-4",children:[e.jsx(z,{className:"w-10 h-10 animate-spin"}),e.jsx("div",{className:"text-slate-600 font-medium",children:"Initializing Cameras..."}),e.jsx("div",{className:"fixed opacity-0 pointer-events-none",children:e.jsx(F,{videoDevices:h,deviceIdMain:j,setDeviceIdMain:g,deviceIdSec:c,setDeviceIdSec:S,videoRefMain:v,videoRefSec:w,realSenseRef:N,isRecording:!1,onSecReady:()=>R(!0)})})]})}const oe=J;export{oe as component};
