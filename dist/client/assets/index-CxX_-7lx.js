import{o as M,p as q,k as B,i as $,b as G,r as m,j as e,n as V}from"./main-DZWvjlLQ.js";import{u as z,L as O}from"./label-B01KzJ1v.js";import{u as P}from"./useMutation-D6MBcEm7.js";import{u as U,C as y,R as H,a as J}from"./use-camera-setup-b0r95oto.js";import{B as K}from"./button-DhTWMI0i.js";import{C as W,a as X,b as Y,d as Z}from"./card-CksVaWOc.js";import{u as ee}from"./UserStore-CFJDJ2oP.js";import"./utils-CwvXAYlB.js";import"./index-BIv2WHLP.js";import"./index-COLG3_It.js";import"./index-tXSsdQnT.js";import"./index-xaBr0Lpv.js";const se=q("3e8463c2903c7b1d998228770fd196c4f38b030596578bf6a4a4fe5d9dc87c44"),ae=M({method:"POST"}).handler(se),te=q("6e10dc167003492fe41b5184f0702cab32b56085f4fe3d4ec79d1a719175f784"),ne=M({method:"POST"}).handler(te),re=u=>new Promise(o=>{const a=new FileReader;a.onloadend=()=>o(a.result),a.readAsDataURL(u)});function oe(){const{questionnaire:u,questions:o}=B({from:"/questionnaire/segmented/"}),a=ee().user,r=$(),A=G(),[n,D]=m.useState(0),[i,b]=m.useState(!1),{videoDevices:g,deviceIdMain:v,setDeviceIdMain:N,deviceIdSec:S,setDeviceIdSec:j,videoRefMain:w,videoRefSec:R,realSenseRef:f,isRecording:E,allReady:p,setSecReady:C,startRecording:_,stopRecording:T}=U(),L=P({mutationFn:ae}),Q=P({mutationFn:ne,onSuccess:()=>{r.reset(),A({to:"/success"})}}),d=z({defaultValues:{answerId:""},onSubmit:async({value:t})=>{b(!0);const s=o[n];f.current?.stopRecording();const{blobMain:h}=await T(),c=h.size>0?await re(h):"",F=`q${n+1}`,k=`/${F}/${a?.name??"Anon"}_${n+1}_${s.id}_main.webm`;let I="";if(c&&(I=(await L.mutateAsync({data:{folderName:r.folderName,fileName:k,fileBase64:c}})).path),r.addAnswer(s.id,{questionId:s.id,answerId:t.answerId,videoMainPath:I,videoSecPath:`/video_uploads/${r.folderName}/${F}/${a?.name??"Anon"}_${n+1}_${s.id}_sec.avi`}),d.reset(),n<o.length-1)D(l=>l+1),b(!1);else{const l={userEmail:a?.email||"anon@example.com",userName:a?.name||"Anon",userClass:a?.class||"-",userGender:a?.gender||"-",userAge:a?.age||0,userNim:a?.nim||"-",userSemester:a?.semester||"-",questionnaireId:u.id,folderName:r.folderName,answers:Object.values($.getState().answers)};await Q.mutateAsync({data:l})}}});m.useEffect(()=>{if(a?.name&&!r.folderName){const t=a.name.replace(/[^a-z0-9]/gi,"_").toLowerCase();r.setFolderName(`segmented/${t}_${Date.now()}`)}},[a,r.folderName,r.setFolderName]),m.useEffect(()=>{if(!p||i||!o)return;const t=setTimeout(()=>{const s=o[n],c=`${`q${n+1}`}/answer_${n+1}_${s.id}_sec.avi`;_({mode:"SEGMENT",folderName:r.folderName,fileName:c})},500);return()=>clearTimeout(t)},[n,p,i,o,r.folderName,_]);const x=o?.[n];return p?e.jsxs("div",{className:"min-h-screen bg-muted/40 p-4 pb-48",children:[e.jsx("div",{className:"max-w-3xl mx-auto mb-6",children:e.jsxs("h1",{className:"text-2xl font-bold",children:["Question ",n+1," / ",o?.length]})}),e.jsx("div",{className:"max-w-3xl mx-auto mb-8",children:e.jsxs("form",{onSubmit:t=>{t.preventDefault(),t.stopPropagation(),d.handleSubmit()},children:[x&&e.jsxs(W,{children:[e.jsx(X,{children:e.jsx(Y,{children:x.question_text})}),e.jsx(Z,{children:e.jsx(d.Field,{name:"answerId",children:t=>e.jsx(H,{value:t.state.value,onValueChange:s=>t.handleChange(s),children:x.answers.map(s=>e.jsxs("div",{className:"flex items-center space-x-2 mb-2 cursor-pointer",children:[e.jsx(J,{value:s.id,id:s.id}),e.jsx(O,{htmlFor:s.id,children:s.answer_text})]},s.id))})})})]}),e.jsx(d.Subscribe,{selector:t=>[t.values.answerId,t.isSubmitting],children:([t,s])=>e.jsx(K,{type:"submit",className:"w-full mt-4 dark:bg-blend-saturation cursor-pointer",disabled:!t||!!s||i,children:s||i?"Saving & Uploading...":n===o.length-1?"Finish":"Next Question"})})]})}),e.jsx(y,{videoDevices:g,deviceIdMain:v,setDeviceIdMain:N,deviceIdSec:S,setDeviceIdSec:j,videoRefMain:w,videoRefSec:R,realSenseRef:f,isRecording:E,onSecReady:()=>C(!0)})]}):e.jsxs("div",{className:"min-h-screen flex flex-col items-center justify-center bg-muted/40 gap-4",children:[e.jsx(V,{className:"w-10 h-10 animate-spin"}),e.jsx("div",{className:"text-slate-600 font-medium",children:"Initializing Cameras..."}),e.jsx("div",{className:"fixed opacity-0 pointer-events-none",children:e.jsx(y,{videoDevices:g,deviceIdMain:v,setDeviceIdMain:N,deviceIdSec:S,setDeviceIdSec:j,videoRefMain:w,videoRefSec:R,realSenseRef:f,isRecording:!1,onSecReady:()=>C(!0)})})]})}const ve=oe;export{ve as component};
